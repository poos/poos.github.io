I"<p>ä½¿ç”¨ Texture æœ‰å‡ å¤§å¥½å¤„ï¼š</p>

<ol>
  <li>
    <p>æ»‘åŠ¨æ€§èƒ½å¿«é€Ÿæå‡</p>
  </li>
  <li>
    <p>å¸ƒå±€æ›´ç®€å•äº†ï¼Œè€Œä¸”æ”¯æŒæ¨ªå±</p>
  </li>
  <li>
    <p>ç‚¹å‡»å¤„ç†æ›´æ–¹ä¾¿äº†ï¼Œä¾‹å¦‚ Texture çš„ TextNode å³æ”¯æŒç‚¹å‡»ï¼›è€Œä¸”æ”¯æŒ hitTest æ‰©å¤§ç‚¹å‡»èŒƒå›´</p>
  </li>
  <li>
    <p>æ›´å¤šä¼˜åŒ–å‚æ•°æ»¡è¶³éœ€æ±‚ï¼Œä¾‹å¦‚ å¤šå±‚å‹ç¼©ä¸ºä¸€å±‚ï¼Œä¸éœ€è¦ç›¸åº”äº‹ä»¶å¯ä»¥é™çº§ä¸º layerï¼Œè‡ªå¸¦ networkImageï¼ˆå¾…ç»­ï¼‰</p>
  </li>
</ol>

<p><strong>10.22 æ›´æ–° ASScrollNode ä½¿ç”¨</strong></p>

<hr />

<p><img src="https://raw.githubusercontent.com/texturegroup/â‰ˆ/master/docs/static/images/logo.png" alt="img" /></p>

<p>å†™åœ¨æ–‡ç« å‰çš„è¯ï¼šæœ‰é—®é¢˜å°±å»æŸ¥æ–‡æ¡£å’Œissuesï¼Œé”™ä¸äº†çš„</p>

<h3 id="ä¸€ä»½ä¸­æ–‡æ–‡æ¡£"><a href="http://texturegroup.org/docs/getting-started.html">ä¸€ä»½ä¸­æ–‡æ–‡æ¡£</a></h3>

<h2 id="æºç åˆ†æ">æºç åˆ†æ</h2>

<blockquote>
  <p>An ASDisplayNode is an abstraction over UIView and CALayer that allows you to perform calculations about a view hierarchy off the main thread, and could do rendering off the main thread as well.</p>
</blockquote>

<p>åŸç†å¤§æ¦‚å°±æ˜¯é‡æ–°å®ç°å¤§éƒ¨åˆ†çš„ UI æ§ä»¶ï¼Œä½¿ç”¨ASDisplayNodeå……åˆ†åˆ©ç”¨åå°çº¿ç¨‹æ¥å®Œæˆå¤æ‚çš„å¸ƒå±€å’Œæ¸²æŸ“ï¼Œè€Œé€šå¸¸UIKitçš„åˆ›å»ºã€å¸ƒå±€è®¡ç®—å’Œæ¸²æŸ“ç»˜åˆ¶éƒ½é›†ä¸­åœ¨ä¸»çº¿ç¨‹ã€‚</p>

<p><a href="https://www.jianshu.com/p/276df9732a70">ç®€ä¹¦ï¼šASDKæºç å‰–æ</a></p>

<p><a href="https://blog.csdn.net/yangyangzhang1990/article/details/52452707">https://blog.csdn.net/yangyangzhang1990/article/details/52452707</a></p>

<p><a href="https://draveness.me/asdk-rendering">ä½¿ç”¨ ASDK æ€§èƒ½è°ƒä¼˜ - æå‡ iOS ç•Œé¢çš„æ¸²æŸ“æ€§èƒ½</a></p>

<p>ä»¥ä¸Šä¸‰ç¯‡æ–‡ç« å¯ä»¥è¯»åˆ° UIView æ˜¯å¦‚ä½•æ¸²æŸ“æ˜¾ç¤ºçš„ï¼Œè€Œ Texture åˆæ˜¯å¦‚ä½•è®¾è®¡æ›¿ä»£æ–¹æ¡ˆçš„ã€‚goole ä¸Šå¯ä»¥å¾ˆå®¹æ˜“æœç´¢åˆ°æ›´å¤šå†…å®¹ï¼Œä¹Ÿå¯ä»¥æŸ¥çœ‹å®˜æ–¹ <a href="https://github.com/TextureGroup/Texture">gtihub</a>.</p>

<h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>

<h3 id="astablenode-ä½¿ç”¨">ASTableNode ä½¿ç”¨</h3>

<p>æ­£å¸¸åƒ tableview ä½¿ç”¨å³å¯ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ ASTableNode æä¾›äº†ä¸€ä¸ª è¿”å› ASCellNodeBlock çš„ä»£ç†æ–¹æ³•ï¼Œå¯ä»¥ç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚</p>

<p><a href="http://texturegroup.org/docs/containers-astablenode.html">æ–‡æ¡£</a></p>

<blockquote>
  <p>It is recommended that you use the node block version of these methods so that your table node will be able to prepare and display all of its cells concurrently. This means that all subnode initialization methods can be run in the background. Make sure to keep â€˜em thread safe.</p>
</blockquote>

<p>ä½¿ç”¨å®åŠ›å¦‚ä¸‹ï¼š</p>

<p>æ™®é€š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">tableNode</span><span class="p">(</span><span class="n">_</span> <span class="nv">tableNode</span><span class="p">:</span> <span class="kt">ASTableNode</span><span class="p">,</span> <span class="n">nodeForRowAt</span> <span class="nv">indexPath</span><span class="p">:</span> <span class="kt">IndexPath</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ASCellNode</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">model</span> <span class="o">=</span> <span class="kt">Models</span><span class="o">.</span><span class="nf">get</span><span class="p">(</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="p">)</span>
    <span class="k">return</span> <span class="kt">NewFriendsView</span><span class="o">.</span><span class="nf">followCell</span><span class="p">(</span><span class="nv">model</span><span class="p">:</span> <span class="n">model</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä½¿ç”¨Block</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">tableNode</span><span class="p">(</span><span class="n">_</span> <span class="nv">tableNode</span><span class="p">:</span> <span class="kt">ASTableNode</span><span class="p">,</span> <span class="n">nodeBlockForRowAt</span> <span class="nv">indexPath</span><span class="p">:</span> <span class="kt">IndexPath</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ASCellNodeBlock</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">returnCellNode</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">ASCellNode</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">model</span> <span class="o">=</span> <span class="kt">Models</span><span class="o">.</span><span class="nf">get</span><span class="p">(</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="p">)</span>
        <span class="k">return</span> <span class="kt">NewFriendsView</span><span class="o">.</span><span class="nf">followCell</span><span class="p">(</span><span class="nv">model</span><span class="p">:</span> <span class="n">model</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// this may be executed on a background thread - it is important to make sure it is thread safe</span>
    <span class="k">let</span> <span class="nv">cellNodeBlock</span> <span class="o">=</span> <span class="p">{</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">ASCellNode</span> <span class="k">in</span>
        <span class="k">let</span> <span class="nv">cellNode</span> <span class="o">=</span> <span class="nf">returnCellNode</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">cellNode</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">cellNodeBlock</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="ascellnode-ä½¿ç”¨">ASCellNode ä½¿ç”¨</h3>

<p><a href="http://texturegroup.org/docs/cell-node.html">æ–‡æ¡£</a></p>

<ul>
  <li>ä½¿ç”¨</li>
</ul>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span><span class="kd">init</span> <span class="err">â€“</span> <span class="kt">Thread</span> <span class="n">safe</span> <span class="n">initialization</span><span class="o">.</span>
<span class="o">-</span><span class="nv">layoutSpecThatFits</span><span class="p">:</span> <span class="err">â€“</span> <span class="kt">Return</span> <span class="n">a</span> <span class="n">layout</span> <span class="n">spec</span> <span class="n">that</span> <span class="n">defines</span> <span class="n">the</span> <span class="n">layout</span> <span class="n">of</span> <span class="n">your</span> <span class="n">cell</span><span class="o">.</span>
<span class="o">-</span><span class="n">didLoad</span> <span class="err">â€“</span> <span class="kt">Called</span> <span class="n">on</span> <span class="n">the</span> <span class="n">main</span> <span class="n">thread</span><span class="o">.</span> <span class="kt">Good</span> <span class="n">place</span> <span class="n">to</span> <span class="n">add</span> <span class="n">gesture</span> <span class="n">recognizers</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span>
<span class="o">-</span><span class="n">layout</span> <span class="err">â€“</span> <span class="kt">Also</span> <span class="n">called</span> <span class="n">on</span> <span class="n">the</span> <span class="n">main</span> <span class="n">thread</span><span class="o">.</span> <span class="kt">Layout</span> <span class="k">is</span> <span class="n">complete</span> <span class="n">after</span> <span class="n">the</span> <span class="n">call</span> <span class="n">to</span> <span class="k">super</span> <span class="n">which</span> <span class="n">means</span> <span class="n">you</span> <span class="n">can</span> <span class="k">do</span> <span class="n">any</span> <span class="n">extra</span> <span class="n">tweaking</span> <span class="n">you</span> <span class="n">need</span> <span class="n">to</span> <span class="k">do</span><span class="o">.</span>
</code></pre></div></div>

<p>ä¸»è¦ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸Šè¾¹å››ä¸ªå‡½æ•°ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ -layoutSpecThatFits: ä¼šè¿”å›å¸ƒå±€æ–¹æ¡ˆã€‚Texture ä½¿ç”¨ FlexBox å¸ƒå±€ï¼Œå…ˆç®€å•æä¸€å¥ï¼Œä¸‹è¾¹ä¼šè¯¦ç»†ä»‹ç»ã€‚</p>

<ul>
  <li>neverShowPlaceholders
    <blockquote>
      <p>Using this option does not eliminate all of the performance advantages of Texture. Normally, a cell has been preloading and is almost done when it reaches the screen, so the blocking time is very short. Even if the rangeTuningParameters are set to 0 this option outperforms UIKit. While the main thread is waiting, subnode display executes concurrently.</p>
    </blockquote>
  </li>
</ul>

<p>å½“æ¸²æŸ“æœªç»“æŸæ—¶å€™ä¸æ˜¾ç¤ºPlaceholderï¼Œè§£å†³éƒ¨åˆ†æƒ…å†µä¸‹é—ªçƒé—®é¢˜ã€‚</p>

<h3 id="å¸ƒå±€">å¸ƒå±€</h3>

<p>Texture çš„å¸ƒå±€çµæ„Ÿæ¥è‡ªCSS Flexboxï¼Œé€šè¿‡ Layout Specsï¼ˆå¸ƒå±€æ ·å¼ï¼‰å’Œ Layout Elementsï¼ˆå¸ƒå±€å…ƒç´ ï¼‰å®ç°å¸ƒå±€ã€‚</p>

<p><a href="http://texturegroup.org/docs/layout2-quickstart.html">æ–‡æ¡£</a></p>

<p>ç½‘ä¸Šä¹Ÿæœ‰å¤§é‡èµ„æ–™å°±ä¸å†èµ˜è¿°äº†ã€‚</p>

<ul>
  <li>Specs</li>
</ul>

<p>å¤§æ¦‚æœ‰ä¸€ä¸‹å¸ƒå±€æ ·å¼ï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹æ–‡æ¡£ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ASWrapperLayoutSpec
ASStackLayoutSpec
ASInsetLayoutSpec
ASOverlayLayoutSpec
ASBackgroundLayoutSpec
ASCenterLayoutSpec
ASRatioLayoutSpec
ASRelativeLayoutSpec
ASAbsoluteLayoutSpec
ASCornerLayoutSpec
</code></pre></div></div>

<p>æä¸€ä¸‹å¸¸ç”¨çš„ï¼š</p>

<p><strong>ASStackLayoutSpec</strong>ï¼Œå®‰ç…§æ¨ªå‘æˆ–è€…ç«–å‘æ’åˆ—å…ƒç´ </p>

<p><strong>ASBackgroundLayoutSpec</strong>ï¼Œè®¾ç½®èƒŒæ™¯å›¾ç‰‡</p>

<p><strong>ASInsetLayoutSpec</strong>ï¼Œç”¨æ¥çº¦æŸèƒŒæ™¯å…ƒç´ ä¸Šä¸‹å·¦å³çš„è·ç¦»</p>

<ul>
  <li>Elements ï¼ˆ<strong>10.22æ›´æ–°</strong>ï¼‰</li>
</ul>

<p>å¸¸ç”¨çš„ UI ç±»éƒ½å¯æ‰¾åˆ°å¯¹åº”çš„ Nodeï¼Œbuttonã€imageã€text ç­‰å°±ä¸ä¸€ä¸€åˆ—ä¸¾äº†ã€‚</p>

<p>æä¸€ä¸‹ ASNetworkImageNode ï¼Œå¯ä»¥ä»ç½‘ç»œä¸‹è½½å›¾ç‰‡çš„ image nodeã€‚ä¸‹ä¸€ä¸ªç›®å½•ä¼šè¯¦ç»†ä»‹ç»</p>

<p><strong>è‡ªå®šä¹‰ node</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>let node = ASDisplayNode { () -&gt; UIView in
	let view = SomeView()
	return view
}
</code></pre></div></div>

<p><strong>ASScollNode</strong></p>

<p>æ³¨æ„å¯ä»¥æŒæœ‰ scollContent é˜²æ­¢å­ node æå‰é‡Šæ”¾</p>
<blockquote>
  <p>var scollContent: ASStackLayoutSpec</p>
</blockquote>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">// init æ—¶å€™çš„ä¸€äº›å‚æ•°ç¤ºä¾‹</span>

    <span class="k">let</span> <span class="nv">scoll</span> <span class="o">=</span> <span class="kt">ASScrollNode</span><span class="p">()</span><span class="o">.</span><span class="n">then</span> <span class="p">{</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">in</span>
        <span class="n">node</span><span class="o">.</span><span class="n">automaticallyManagesContentSize</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="n">node</span><span class="o">.</span><span class="n">automaticallyManagesSubnodes</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="n">node</span><span class="o">.</span><span class="n">autoresizesSubviews</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="n">node</span><span class="o">.</span><span class="n">scrollableDirections</span> <span class="o">=</span> <span class="o">.</span><span class="n">right</span>
<span class="c1">//        node.autoresizingMask = [.flexibleWidth, .flexibleHeight]</span>
        <span class="n">node</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="kt">UIColor</span><span class="o">.</span><span class="n">white</span>
        <span class="n">node</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">showsHorizontalScrollIndicator</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">}</span>


    <span class="c1">// layoutæ—¶å€™ä¸å…¶ä»–æ§ä»¶çš„ä¸åŒç‚¹</span>

    <span class="n">scoll</span><span class="o">.</span><span class="n">layoutSpecBlock</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="k">in</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="p">`</span><span class="nv">self</span><span class="p">`</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kt">ASLayoutSpec</span><span class="p">()</span> <span class="p">}</span>

        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="nf">layoutScoll</span><span class="p">()</span>
    <span class="p">}</span>


</code></pre></div></div>

<ul>
  <li>å¸ƒå±€çš„ç»†å¾®è°ƒæ•´ï¼ŒElement Properties å’Œ API Sizing</li>
</ul>

<p><a href="http://texturegroup.org/docs/layout2-layout-element-properties.html">Element Properties</a></p>

<p><a href="http://texturegroup.org/docs/layout2-api-sizing.html">API Sizing</a></p>

<p>åŒæ ·æä¸€ä¸‹å¸¸ç”¨çš„ï¼š</p>

<p><strong>style.flexShrink</strong> / <strong>style.flexGrow</strong> ï¼Œtext node ç­‰ å¤§å°å¯å˜çš„å¦‚æœè¶…å‡ºæˆ–è€…ä¸è¶³çˆ¶ spaces çš„æƒ…å†µä¸‹è¿›è¡Œç¼©å°å’Œå¢é•¿</p>

<p><strong>hitTestSlop</strong> ï¼Œæ‰©å¤§ç‚¹å‡»èŒƒå›´</p>

<p><strong>style.spacingAfter</strong> / <strong>style.spacingBefore</strong> ï¼Œå…ƒç´ æ’åˆ—æ—¶å€™çš„å‰åé—´è·</p>

<p><strong>style.preferredSize</strong>ï¼Œå¤§å°</p>

<p><strong>.style.flexBasis = ASDimensionMake(â€œ40%â€)</strong>ï¼Œè¿˜æœ‰æŒ‰ç…§çˆ¶ spaces çš„æ¯”ä¾‹å¸ƒå±€çš„</p>

<h3 id="networkimagenode-é—ªçƒ-å’Œ-ç¼“å­˜">NetworkImageNode é—ªçƒ å’Œ ç¼“å­˜</h3>
<p>ASNetworkImageNode ä½¿ç”¨çš„æ˜¯ Texture è‡ªå·±çš„å›¾ç‰‡ç¼“å­˜ç³»ç»Ÿï¼Œæ‰€ä»¥å°±æœ‰å’Œé¡¹ç›®é»˜è®¤çš„å›¾ç‰‡ç¼“å­˜å¯¹æ¥çš„é—®é¢˜ã€‚</p>

<p>ASNetworkImageNode æ¯æ¬¡ä»ç½‘ç»œåŠ è½½ï¼ˆå³ä½¿ä»ç¼“å­˜åŠ è½½ï¼‰éƒ½ä¼šå…ˆæ˜¾ç¤ºé»˜è®¤å ä½å›¾ï¼Œç„¶åæ‰æ˜¾ç¤ºä¸‹è½½çš„å›¾ç‰‡ï¼Œæ‰€ä»¥åœ¨ reload table ä¼šé—ªçƒ</p>

<ul>
  <li>å¯¹æ¥é¡¹ç›®ç¼“å­˜</li>
</ul>

<p>å¯¹æ¥ç¼“å­˜éœ€è¦å®ç° ASImageCacheProtocol ä¸­çš„å‡ ä¸ªä»£ç†æ–¹æ³•å³å¯ï¼š</p>

<p><strong>downloadImage(â€¦) -&gt; Any?</strong></p>

<p><strong>cancelImageDownload</strong></p>

<p><strong>cachedImage</strong></p>

<p>ç¤ºä¾‹ä¾‹ä¸€ä¸ªå¯¹æ¥ Kingfisher çš„ä»£ç </p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">Kingfisher</span>

<span class="kd">extension</span> <span class="kt">ASNetworkImageNode</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">imageNode</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">ASNetworkImageNode</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">ASNetworkImageNode</span><span class="p">(</span><span class="nv">cache</span><span class="p">:</span> <span class="kt">ASImageManager</span><span class="o">.</span><span class="n">shared</span><span class="p">,</span> <span class="nv">downloader</span><span class="p">:</span> <span class="kt">ASImageManager</span><span class="o">.</span><span class="n">shared</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">ASImageManager</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">ASImageDownloaderProtocol</span><span class="p">,</span> <span class="kt">ASImageCacheProtocol</span> <span class="p">{</span>

    <span class="kd">static</span> <span class="k">let</span> <span class="nv">shared</span> <span class="o">=</span> <span class="kt">ASImageManager</span><span class="p">()</span>
    <span class="kd">private</span> <span class="k">override</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{}</span>

    <span class="kd">func</span> <span class="nf">downloadImage</span><span class="p">(</span><span class="n">with</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">callbackQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="p">,</span> <span class="nv">downloadProgress</span><span class="p">:</span> <span class="kt">ASImageDownloaderProgress</span><span class="p">?,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="kt">ASImageDownloaderCompletion</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Any</span><span class="p">?</span> <span class="p">{</span>

        <span class="kt">ImageDownloader</span><span class="o">.</span><span class="k">default</span><span class="o">.</span><span class="n">downloadTimeout</span> <span class="o">=</span> <span class="mf">30.0</span>
        <span class="k">var</span> <span class="nv">operation</span><span class="p">:</span> <span class="kt">RetrieveImageDownloadTask</span><span class="p">?</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="kt">ImageDownloader</span><span class="o">.</span><span class="k">default</span><span class="o">.</span><span class="nf">downloadImage</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">progressBlock</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">received</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span> <span class="k">in</span>
            <span class="k">if</span> <span class="n">downloadProgress</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="n">callbackQueue</span><span class="o">.</span><span class="nf">async</span><span class="p">(</span><span class="nv">execute</span><span class="p">:</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="nv">progress</span> <span class="o">=</span> <span class="n">expected</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">?</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">received</span> <span class="o">/</span> <span class="n">expected</span>
                    <span class="nf">downloadProgress</span><span class="p">?(</span><span class="kt">CGFloat</span><span class="p">(</span><span class="n">progress</span><span class="p">))</span>
                <span class="p">})</span>
            <span class="p">}</span>
        <span class="p">},</span> <span class="nv">completionHandler</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="k">in</span>
            <span class="k">if</span> <span class="n">image</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="n">callbackQueue</span><span class="o">.</span><span class="nf">async</span><span class="p">(</span><span class="nv">execute</span><span class="p">:</span> <span class="p">{</span> <span class="nf">completion</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">})</span>
                <span class="kt">ImageCache</span><span class="o">.</span><span class="k">default</span><span class="o">.</span><span class="nf">store</span><span class="p">(</span><span class="n">image</span><span class="o">!</span><span class="p">,</span> <span class="nv">original</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="n">url</span><span class="o">.</span><span class="n">cacheKey</span><span class="p">,</span> <span class="nv">toDisk</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">callbackQueue</span><span class="o">.</span><span class="nf">async</span><span class="p">(</span><span class="nv">execute</span><span class="p">:</span> <span class="p">{</span> <span class="nf">completion</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">})</span>
            <span class="p">}</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="n">operation</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">cancelImageDownload</span><span class="p">(</span><span class="n">forIdentifier</span> <span class="nv">downloadIdentifier</span><span class="p">:</span> <span class="kt">Any</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">task</span> <span class="o">=</span> <span class="n">downloadIdentifier</span> <span class="k">as?</span> <span class="kt">RetrieveImageDownloadTask</span> <span class="p">{</span>
            <span class="n">task</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">cachedImage</span><span class="p">(</span><span class="n">with</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">callbackQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="kt">ASImageCacherCompletion</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">ImageCache</span><span class="o">.</span><span class="k">default</span><span class="o">.</span><span class="nf">retrieveImage</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">url</span><span class="o">.</span><span class="n">cacheKey</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="k">in</span>
            <span class="n">callbackQueue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="nf">completion</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>å›¾ç‰‡ reload é—ªçƒ</li>
</ul>

<p>åŸç†æ˜¯ ä½¿ç”¨ä¸¤ä¸ª nodeï¼ˆASNetworkImageNode å’Œ ASImageNodeï¼‰ï¼Œæ— ç¼“å­˜å³ä½¿ç”¨ ASNetworkImageNod åŠ è½½ç½‘ç»œå›¾ç‰‡ï¼Œæœ‰ç¼“å­˜å³ä½¿ç”¨ ASImageNode ç›´æ¥æ˜¾ç¤ºã€‚</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">AsyncDisplayKit</span>

<span class="c1">// MARK: - ASNetworkImageNode ä»¥è§£å†³reloadé—ªçƒé—®é¢˜</span>
<span class="kd">class</span> <span class="kt">NetworkImageNode</span><span class="p">:</span> <span class="kt">ASDisplayNode</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">networkImageNode</span> <span class="o">=</span> <span class="kt">ASNetworkImageNode</span><span class="o">.</span><span class="nf">imageNode</span><span class="p">()</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">imageNode</span> <span class="o">=</span> <span class="kt">ASImageNode</span><span class="p">()</span>

    <span class="k">var</span> <span class="nv">defaultImage</span><span class="p">:</span> <span class="kt">UIImage</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="n">networkImageNode</span><span class="o">.</span><span class="n">defaultImage</span> <span class="o">=</span> <span class="n">defaultImage</span>
            <span class="n">imageNode</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">defaultImage</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">var</span> <span class="nv">cornerRadius</span><span class="p">:</span> <span class="kt">CGFloat</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="n">networkImageNode</span><span class="o">.</span><span class="n">cornerRadius</span> <span class="o">=</span> <span class="n">cornerRadius</span>
            <span class="n">imageNode</span><span class="o">.</span><span class="n">cornerRadius</span> <span class="o">=</span> <span class="n">cornerRadius</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">var</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="n">url</span> <span class="p">{</span>
                <span class="k">if</span> <span class="kt">ImageCache</span><span class="o">.</span><span class="k">default</span><span class="o">.</span><span class="nf">imageCachedType</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">url</span><span class="o">.</span><span class="n">cacheKey</span><span class="p">)</span><span class="o">.</span><span class="n">cached</span> <span class="p">{</span>
                    <span class="kt">ImageCache</span><span class="o">.</span><span class="k">default</span><span class="o">.</span><span class="nf">retrieveImage</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">url</span><span class="o">.</span><span class="n">cacheKey</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">completionHandler</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="k">in</span>
                        <span class="k">if</span> <span class="k">let</span> <span class="nv">image</span> <span class="o">=</span> <span class="n">image</span> <span class="p">{</span>
                            <span class="k">self</span><span class="o">.</span><span class="n">imageNode</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">image</span>
                        <span class="p">}</span>
                    <span class="p">})</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">self</span><span class="o">.</span><span class="n">networkImageNode</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="nf">addSubnode</span><span class="p">(</span><span class="n">networkImageNode</span><span class="p">)</span>
        <span class="nf">addSubnode</span><span class="p">(</span><span class="n">imageNode</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="kd">func</span> <span class="nf">layoutSpecThatFits</span><span class="p">(</span><span class="n">_</span> <span class="nv">constrainedSize</span><span class="p">:</span> <span class="kt">ASSizeRange</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ASLayoutSpec</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="n">networkImageNode</span><span class="o">.</span><span class="n">url</span><span class="p">?</span><span class="o">.</span><span class="n">absoluteString</span> <span class="p">??</span> <span class="s">""</span>
        <span class="k">return</span> <span class="kt">ASInsetLayoutSpec</span><span class="p">(</span><span class="nv">insets</span><span class="p">:</span> <span class="o">.</span><span class="n">zero</span><span class="p">,</span> <span class="nv">child</span><span class="p">:</span> <span class="n">url</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">?</span> <span class="nv">networkImageNode</span> <span class="p">:</span> <span class="n">imageNode</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">addTarget</span><span class="p">(</span><span class="n">_</span> <span class="nv">target</span><span class="p">:</span> <span class="kt">Any</span><span class="p">?,</span> <span class="nv">action</span><span class="p">:</span> <span class="kt">Selector</span><span class="p">,</span> <span class="n">forControlEvents</span> <span class="nv">controlEvents</span><span class="p">:</span> <span class="kt">ASControlNodeEvent</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">networkImageNode</span><span class="o">.</span><span class="nf">addTarget</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nv">action</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="nv">forControlEvents</span><span class="p">:</span> <span class="n">controlEvents</span><span class="p">)</span>
        <span class="n">imageNode</span><span class="o">.</span><span class="nf">addTarget</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nv">action</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="nv">forControlEvents</span><span class="p">:</span> <span class="n">controlEvents</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p>å­¦ä¹ å’Œä½¿ç”¨è¿˜æ˜¯å¾ˆå¿«çš„ï¼ŒåŸç†ç†è§£å°±è¦å¤šçœ‹å¤šå®è·µæ‰èƒ½ç†è§£é€å½»ï¼Œå°šæœªæ¶ˆåŒ–ï¼Œæ‰€æœ‰åŸç†æ–¹é¢ç®€å•åˆ—ä¸¾ä¸€ä¸‹ã€‚ä½¿ç”¨ä¸Šå°±æ˜¯å¤šçœ‹ <strong>æ–‡æ¡£</strong>ï¼Œ <strong>github</strong>ï¼Œ é—®é¢˜è§£å†³ä¼šæ¯”è¾ƒå¿«ã€‚</p>

<p>è¿™äº›èµ„æ–™å¯èƒ½å¸®åˆ°ä½ ï¼š</p>

<p><a href="https://www.jianshu.com/p/fde96c5bc43f">AsyncDisplayKit åˆçª¥</a></p>

<p><a href="http://www.cocoachina.com/ios/20170809/20182.html">è´èŠç§‘æŠ€-AsyncDisplayKitè¿‘ä¸€å¹´çš„ä½¿ç”¨ä½“ä¼šåŠç–‘éš¾ç‚¹</a></p>

<p><a href="https://awhisper.github.io/2016/05/04/AsyncDisplayKitå®˜æ–¹æ–‡æ¡£ç¿»è¯‘/">AsyncDisplayKitå®˜æ–¹æ–‡æ¡£ç¿»è¯‘</a></p>

<p><a href="https://blog.csdn.net/qq_19957803/article/details/77749379">AsyncDispalyKit reloadDataåˆ·æ–°åˆ—è¡¨é—ªå±é—®é¢˜åˆ†æåŠè§£å†³æ–¹æ¡ˆ</a></p>

<p><a href="https://github.com/facebookarchive/AsyncDisplayKit/issues/2871">ASNetworkImageNode can NOT load animatedData sometime #2871</a></p>

<p><a href="https://blog.ibireme.com/2015/11/12/smooth_user_interfaces_for_ios/">iOS ä¿æŒç•Œé¢æµç•…çš„æŠ€å·§</a></p>
:ET